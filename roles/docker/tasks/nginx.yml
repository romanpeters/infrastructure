---
- name: Install dependencies
  ansible.builtin.apt:
    name:
      - nginx

- name: Copy Nginx files
  ansible.builtin.template:
    src: nginx.j2
    dest: "/etc/nginx/sites-available/{{ item.name }}"
  vars:
    service_name: "{{ item.name }}"
    service_port: "{{ item.port }}"
  loop: "{{ docker_services }}"

- name: Enable sites
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ item.name }}"
    dest: "/etc/nginx/sites-enabled/{{ item.name }}"
    state: link
  loop: "{{ docker_services }}"

- name: Test Nginx configuration
  ansible.builtin.command: nginx -t
  changed_when: false
  notify: Restart nginx

- name: Set IP address for service
  ansible.builtin.set_fact:
    host_ip: "{{ ansible_default_ipv4.address }}"

- name: Copy Nginx file to proxy server
  ansible.builtin.template:
    src: nginx.j2
    dest: "/etc/nginx/sites-available/{{ item.name }}"
  vars:
    service_ip: "{{ host_ip }}"
    service_name: "{{ item.name }}"
    service_port: "{{ item.port }}"
  loop: "{{ docker_services }}"
  delegate_to: "{{ webserver_host }}"

- name: Enable sites on proxy server
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ item.name }}"
    dest: "/etc/nginx/sites-enabled/{{ item.name }}"
    state: link
  loop: "{{ docker_services }}"
  delegate_to: "{{ webserver_host }}"

- name: Test Nginx configuration
  ansible.builtin.command: nginx -t
  changed_when: false
  notify: Restart nginx proxy
  delegate_to: "{{ webserver_host }}"
